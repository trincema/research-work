% Create Scenario
startTime = datetime(2023,10,9,7,10,0,TimeZone="America/New_York");
stopTime = startTime + hours(2) + minutes(2);
sampleTime = 10;                                      %seconds
sc = satelliteScenario(startTime,stopTime,sampleTime);
viewer = satelliteScenarioViewer(sc);

% Airports
airportName = ["JFK International (New York)";...
    "L.F. Wade International (Bermuda)"];
airportLat = [40.6413;32.3634];
airportLon = [-73.7781;-64.7053];
airports = groundStation(sc,airportLat,airportLon,Name=airportName);

% Aircraft
waypoints = [... % Latitude (deg), Longitude (deg), Altitude (meters)
    40.6289,-73.7738,3;...
   40.6325,-73.7819,3;...
   40.6341,-73.7852,44;...
   40.6400,-73.7974,265;...
   40.6171,-73.8618,1012;...
   40.5787,-73.8585,1698;...
   39.1452,-71.6083,11270;...
   34.2281,-66.0839,11264;...
   32.4248,-64.4389,970;...
   32.3476,-64.4565,574;...
   32.3320,-64.4915,452;...
   32.3459,-64.5712,453;...
   32.3610,-64.6612,18;...
   32.3621,-64.6678,3;...
   32.3639,-64.6777,3];

timeOfArrival = duration([... % time (HH:mm:ss)
   "00:00:00";...
   "00:00:20";...
   "00:00:27";...
   "00:00:43";...
   "00:01:47";...
   "00:02:21";...
   "00:21:25";...
   "01:32:39";...
   "01:54:27";...
   "01:55:47";...
   "01:56:27";...
   "01:57:48";...
   "01:59:49";...
   "01:59:55";...
   "02:00:15"]);

trajectory = geoTrajectory(waypoints,seconds(timeOfArrival),AutoPitch=true,AutoBank=true);
LLA = lookupPose(trajectory,0:sc.SampleTime:max(seconds(timeOfArrival)));
geoplot(LLA(:,1), LLA(:,2), "b-")
geolimits([31,42],[-76,-63]);
geobasemap topographic;

aircraft = platform(sc, trajectory, ...
    'Visual3DModel', 'NarrowBodyAirliner.glb');
camtarget(viewer,aircraft);
numSatellitesPerOrbitalPlane = 11;
numOrbits = 6;

orbitIdx = repelem(1:numOrbits,1,numSatellitesPerOrbitalPlane);
planeIdx = repmat(1:numSatellitesPerOrbitalPlane,1,numOrbits);

RAAN = 180*(orbitIdx-1)/numOrbits;
trueanomaly = 360*(planeIdx-1 + 0.5*(mod(orbitIdx,2)-1))/numSatellitesPerOrbitalPlane;
semimajoraxis = repmat((6371 + 780)*1e3,size(RAAN)); % meters
inclination = repmat(86.4,size(RAAN)); % degrees
eccentricity = zeros(size(RAAN)); % degrees
argofperiapsis = zeros(size(RAAN)); % degrees

iridiumSatellites = satellite(sc,...
    semimajoraxis,eccentricity,inclination,RAAN,argofperiapsis,trueanomaly,...
    Name="Iridium " + string(1:66)');

hide(iridiumSatellites.Orbit,viewer);
show(iridiumSatellites(1:numSatellitesPerOrbitalPlane:end).Orbit,viewer);
iridiumConicalSensors = conicalSensor(iridiumSatellites,"MaxViewAngle",125);

% Aircraft Access Analysis
acAirport = access(aircraft,sc.GroundStations);
airportAccessIntvls = accessIntervals(acAirport)
acSatellite = access(aircraft,iridiumConicalSensors);
satelliteAccessIntvls = accessIntervals(acSatellite);

